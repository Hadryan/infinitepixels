<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=false;">

<title>Ember Starter Kit</title>
	<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
	<style type="text/css">
		html,
		body,
		ul {
			padding: 0;
			margin: 0;
		}
		html {
			font-family: "Helvetica Neue", "Helvetica", "Arial", sans-serif;
			background: #222;
		}
		#lightbox {
			position: fixed;
			z-index: 2;
			background: rgba(0, 0, 0, 0.9);
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			display: none;
			padding: 20px;
		}

		#lightbox-target {
			height: 100%;
			width: 100%;
			background-position: center;
			background-repeat: no-repeat;
			background-size: contain;
		}

		#lightbox.visible {
			display: block;
		}

		#lightbox #controls {
			display: none;
		}

		#lightbox.show-controls #controls {
			display: block;
		}

		#controls {
			text-align: center;
			overflow: hidden;
			width: 210px;
			margin: 0 auto;
		}

		#controls a {
			display: block;
			float: left;
			color: #fff;
			text-decoration: none;
			text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
			padding: 10px 20px;
		}

		#main-header {
			position: fixed;
			background: -webkit-linear-gradient(#5952FF, #2800A7);
			box-shadow: inset 0 1px #817CFF, 0 1px 3px rgba(0, 0, 0, 0.2);
			top: 0;
			left: 0;
			right: 0;
			margin: 0;
		}

		#main-header form {
			position: absolute;
			right: 20px;
			top: 11px;
		}

		#main-header input {
			background: rgba(0, 0, 0, 0.1);
			border: 1px solid rgba(0, 0, 0, 0.2);
			border-radius: 4px;
			height: 15px;
			line-height: 15px;
			padding: 5px 10px;
			width: 175px;
			border-color: rgba(0, 0, 0, 0.15) rgba(0, 0, 0, 0.07) rgba(255, 255, 255, 0.12);
			box-shadow: inset 0px 1px 2px rgba(0, 0, 0, 0.1);
			outline: 0;
			color: #fff;
		}

		#main-nav {
			overflow: hidden;
			list-style-type: none;
		}

		#main-nav li a {
			display: block;
			float: left;
			margin: 16px;
			color: #FFF;
			text-decoration: none;
			text-transform: uppercase;
			font-family: "Helvetica Neue";
			font-weight: 500;
			font-size: 13px;
			text-shadow: 0 -1px #0070A3; 
		}

		#photolist {
			font-size: 0;
			list-style-type: none;
			margin: 52px auto 0;
		}

		#photolist li {
			margin: 5px;
			display: inline-block;
		}

		#main-content {
			margin: 0 auto;
		}

		#main-content.loading {
			background-image: url(../img/loading.gif);
			background-position: center center;
			background-repeat: no-repeat;
			height: 100%;
			width: 100%;
			position: absolute;
		}
	</style>
</head>
<body>
	<header id="main-header">
		<ul id="main-nav">
			<li>
				<a href="#photos/popular">Popular</a>
			</li>
			<li>
				<a href="#photos/upcoming">Upcoming</a>
			</li>
			<li>
				<a href="#photos/fresh">Fresh</a>
			</li>
			<li>
				<a href="#photos/favorites">My Favorites</a>
			</li>
			<li>
				<a href="javascript:void(0)" onclick="_500px.login();this.html=''">Login</a>
			</li>
		</ul>
		<form>
			<input type="text" placeholder="Search photos"/>
		</form>
	</header>
	<div id="app">
		<ul id="photolist">
		</ul>
	</div>

	<script id="template-image" type="text/x-handlebars-template">
		<a href="#/photo/<%= id %>">
			<img src="<%= image_url %>" alt="<%- description %>" height="280" width="280" />
		</a>
	</script>

	<script src="js/libs/jquery-1.9.1.js"></script>
	<script src="js/libs/json2.js"></script>
	<script src="js/libs/underscore.js"></script>
	<script src="js/libs/backbone.js"></script>
	<script type="application/javascript" src="js/libs/500px.js"></script>
	<script type="application/javascript">
	//TODO de-globalize this
		_500px.init({
			sdk_key: 'ff47a113fe64f79dc9eb386df8420deec635870b'
		});

		var App = {
			popular: function() {
				Images.fetch({
					"feature": "popular"
				});
			},
			fresh: function() {},
			upcoming: function() {},
		};

		var Image = Backbone.Model.extend({
		});

		var ImageView = Backbone.View.extend({
			tagName: "li",
			template: _.template($('#template-image').html()),
			events: {

			},
			initialize: function() {
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.model, 'remove', this.remove);
			},
			render: function() {
				this.$el.html(this.template(this.model.toJSON()));
				return this;
			}
		});

		var ImageList = Backbone.Collection.extend({
			model: Image,
			fetch: function(params) {
				this.trigger('fetchstart');
				var self = this;
				_500px.api('/photos', params, function(response) {
					self.reset(response.data.photos);
					self.trigger('fetchend');
				});
			}
		});

		var Images = new ImageList;

		var AppView = Backbone.View.extend({
			el: $('#app'),

			events: {
			},

			initialize: function() {
				//Attached events that occur outside the framework
				$(window).on('resize', $.proxy(this.normalizeView, this));
				_500px.on('authorization_obtained', $.proxy(function () {
					this.trigger('authorization_obtained');	
				}, this));

				this.on('authorization_obtained', this.authUser);
				this.$photolist = $("#photolist");
				this.listenTo(Images, 'fetchend', this.renderImageList);
				this.listenTo(Images, 'fetchstart', this.clearImageList);
				this.normalizeView();
			},

			clearImageList: function() {
				this.$photolist.html('');
			},

			renderImageList: function(name) {
				this.$photolist.html('');
				Images.each(function(image) {
					var view = new ImageView({model: image});
					this.$photolist.append(view.render().el);
				}, this);
			},

			normalizeView: function() {
				this.$photolist.width( this.fitContent(290) );
			},

			fitContent: function(width) {
				return Math.floor( $(window).width() / width ) * width;
			},

			authUser: function() {
				_500px.api('/users', function (response) {
					var me = response.data.user;
					console.log(me);
				})
			}
		});


		var Router = Backbone.Router.extend({
			routes: {
				"photos/:feature(/:user_id)":  "photolist",
				"photo/:id":                   "photo",
			},
			photolist: function(feature, userId) {
				Images.fetch({
					"feature": feature,
					"image_size": 3
				})
			},
			photo: function(id) {
				App.showPhoto(id);
			}
		});

		var route = new Router();

		var App = new AppView();
		Backbone.history.start();
  </script>

</body>
</html>
